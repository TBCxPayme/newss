<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–¥–º–∏–Ω ‚Äî TBCxPayme CUP</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* –õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–µ–±–æ–ª—å—à–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ (–≤–¥–æ–±–∞–≤–æ–∫ –∫ style.css) */
    .admin-container { max-width: 1000px; margin: 40px auto; padding: 28px; }
    .field { margin: 8px 0; }
    label { display:block; margin-bottom:6px; color:#bfefff; }
    input[type="text"], input[type="password"] { width: 320px; padding:8px; border-radius:6px; border:1px solid rgba(0,255,200,0.2); background:rgba(0,0,0,0.35); color:#e6fff8; }
    #ownerRepo { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .log { margin-top:12px; padding:10px; background:rgba(0,0,0,0.45); color:#9ff; border-radius:6px; height:120px; overflow:auto; font-family:monospace; font-size:13px; }
    .small { font-size:13px; color:#9fe8e0; }
  </style>
</head>
<body class="admin-body">
  <div class="admin-container">
    <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî TBCxPayme CUP</h1>

    <div class="field" id="ownerRepo">
      <div>
        <label>–í–ª–∞–¥–µ–ª–µ—Ü (owner)</label>
        <input id="owner" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: TBCxPayme" value="TBCxPayme">
      </div>
      <div>
        <label>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (repo)</label>
        <input id="repo" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: CyberSport" value="CyberSport">
      </div>
    </div>

    <div class="field">
      <label>üîë GitHub token (classic) ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ sessionStorage</label>
      <input id="token" type="password" placeholder="ghp_xxx..." />
      <button id="saveTokenBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
    </div>

    <div class="field">
      <label>üìù Commit message</label>
      <input id="commitMsg" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã" />
    </div>

    <div style="margin:12px 0;">
      <button id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å data.json –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è</button>
      <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å data.json –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</button>
      <span class="small">(–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ ‚Äî –∑–∞—Ç–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ)</span>
    </div>

    <div id="status" class="status-box" style="display:none"></div>

    <div id="adminBracket"></div>

    <h3>–õ–æ–≥</h3>
    <pre id="log" class="log"></pre>
  </div>

  <script>
  // helper for unicode -> base64
  function toBase64(str){ return btoa(unescape(encodeURIComponent(str))); }
  function fromBase64(b64){ return decodeURIComponent(escape(atob(b64))); }

  const ownerInput = document.getElementById('owner');
  const repoInput = document.getElementById('repo');
  const tokenInput = document.getElementById('token');
  const saveTokenBtn = document.getElementById('saveTokenBtn');
  const loadBtn = document.getElementById('loadBtn');
  const saveBtn = document.getElementById('saveBtn');
  const commitMsgInput = document.getElementById('commitMsg');
  const adminBracket = document.getElementById('adminBracket');
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');

  let fileSha = null;
  let dataset = null;
  const PATH = 'data.json';

  function log(msg){
    const time = new Date().toLocaleTimeString();
    logEl.textContent += `[${time}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function showStatus(text, type='info'){
    statusEl.style.display = 'block';
    statusEl.textContent = text;
    statusEl.className = 'status-box ' + (type==='success'?'success': type==='error'?'error':'loading');
  }

  saveTokenBtn.addEventListener('click', ()=>{
    const token = tokenInput.value.trim();
    if(!token){ showStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error'); return; }
    sessionStorage.setItem('GHTOKEN', token);
    showStatus('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Å–µ—Å—Å–∏–∏', 'success'); log('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ sessionStorage');
  });

  loadBtn.addEventListener('click', async ()=>{
    const owner = ownerInput.value.trim();
    const repo = repoInput.value.trim();
    const token = sessionStorage.getItem('GHTOKEN');
    if(!owner || !repo){ showStatus('–£–∫–∞–∂–∏—Ç–µ owner –∏ repo', 'error'); return; }
    if(!token){ showStatus('–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ —Å–µ—Å—Å–∏–∏', 'error'); return; }

    showStatus('–ó–∞–≥—Ä—É–∂–∞—é data.json...', 'loading'); log(`GET /repos/${owner}/${repo}/contents/${PATH}`);
    try{
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${PATH}`, {
        headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' }
      });
      if(!res.ok){ const err = await res.json(); throw new Error(err.message || res.status); }
      const j = await res.json();
      fileSha = j.sha;
      dataset = JSON.parse(fromBase64(j.content));
      showStatus('‚úÖ data.json –∑–∞–≥—Ä—É–∂–µ–Ω', 'success'); log('data.json –∑–∞–≥—Ä—É–∂–µ–Ω, sha=' + fileSha);
      renderAdmin(dataset.rounds);
    }catch(e){
      showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, 'error'); log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
    }
  });

  function renderAdmin(rounds){
    adminBracket.innerHTML = '';
    rounds.forEach((round, rIndex) => {
      const block = document.createElement('div');
      block.className = 'round';
      const h = document.createElement('h3'); h.textContent = round.name; block.appendChild(h);

      round.matches.forEach((m, mIndex) => {
        const row = document.createElement('div');
        row.className = 'match';
        row.style.display = 'flex'; row.style.gap='8px'; row.style.alignItems='center';
        row.innerHTML = `
          <input data-r="${rIndex}" data-m="${mIndex}" data-field="teamA" value="${m.teamA}" />
          <input data-r="${rIndex}" data-m="${mIndex}" data-field="scoreA" type="number" value="${m.scoreA}" style="width:80px"/>
          <span style="margin:0 6px">vs</span>
          <input data-r="${rIndex}" data-m="${mIndex}" data-field="teamB" value="${m.teamB}" />
          <input data-r="${rIndex}" data-m="${mIndex}" data-field="scoreB" type="number" value="${m.scoreB}" style="width:80px"/>
        `;
        // listeners:
        row.querySelectorAll('input').forEach(inp=>{
          inp.addEventListener('change', (e)=>{
            const r = +inp.dataset.r, mm = +inp.dataset.m, field = inp.dataset.field;
            const val = field.includes('score') ? Number(inp.value) : inp.value;
            dataset.rounds[r].matches[mm][field] = val;
          });
        });
        block.appendChild(row);
      });

      adminBracket.appendChild(block);
    });
  }

  saveBtn.addEventListener('click', async ()=>{
    const owner = ownerInput.value.trim();
    const repo = repoInput.value.trim();
    const token = sessionStorage.getItem('GHTOKEN');
    const commitMsg = commitMsgInput.value.trim() || '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ data.json –∏–∑ –∞–¥–º–∏–Ω–∫–∏';
    if(!owner||!repo) return showStatus('–£–∫–∞–∂–∏—Ç–µ owner/repo', 'error');
    if(!token) return showStatus('–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ —Å–µ—Å—Å–∏–∏', 'error');
    if(!dataset) return showStatus('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ data.json', 'error');

    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${PATH}`;
    const content = toBase64(JSON.stringify(dataset, null, 2));

    showStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ GitHub...', 'loading'); log('PUT ' + url);

    try{
      // get current sha if we don't have
      if(!fileSha){
        const g = await fetch(url, { headers: { Authorization: `token ${token}` } });
        if(!g.ok){ const err = await g.json(); throw new Error(err.message || g.status); }
        const gj = await g.json(); fileSha = gj.sha; log('–ü–æ–ª—É—á–µ–Ω sha: ' + fileSha);
      }

      const res = await fetch(url, {
        method:'PUT',
        headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({
          message: commitMsg,
          content: content,
          sha: fileSha
        })
      });

      const result = await res.json();
      if(res.ok){
        fileSha = result.content.sha; // –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π sha
        showStatus('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏', 'success');
        log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ, –Ω–æ–≤—ã–π sha=' + fileSha);
      } else {
        throw new Error(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
      }
    }catch(err){
      showStatus('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      log('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + err.message);
    }
  });

  // –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ data.json (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä)
  (async ()=>{ 
    // –ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Å –∫–æ—Ä–Ω—è –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞
    try{
      const r = await fetch('data.json');
      if(r.ok){ const d = await r.json(); /* –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å */ }
    }catch(e){}
  })();

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–¥–º–∏–Ω ‚Äî TBCxPayme CUP</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-container { max-width: 1000px; margin: 40px auto; padding: 28px; }
    .field { margin: 8px 0; }
    label { display:block; margin-bottom:6px; color:#bfefff; }
    input[type="text"], input[type="password"] { width: 320px; padding:8px; border-radius:6px; border:1px solid rgba(0,255,200,0.2); background:rgba(0,0,0,0.35); color:#e6fff8; }
    #ownerRepo { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .log { margin-top:12px; padding:10px; background:rgba(0,0,0,0.45); color:#9ff; border-radius:6px; height:120px; overflow:auto; font-family:monospace; font-size:13px; }
    .small { font-size:13px; color:#9fe8e0; }
  </style>
</head>
<body class="admin-body">
  <div class="admin-container">
    <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî TBCxPayme CUP</h1>

    <div class="field" id="ownerRepo">
      <div>
        <label>–í–ª–∞–¥–µ–ª–µ—Ü (owner)</label>
        <input id="owner" type="text" value="TBCxPayme">
      </div>
      <div>
        <label>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (repo)</label>
        <input id="repo" type="text" value="CyberSport">
      </div>
    </div>

    <div class="field">
      <label>üîë GitHub token</label>
      <input id="token" type="password" placeholder="ghp_xxx..." />
      <button id="saveTokenBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
    </div>

    <div class="field">
      <label>üìù Commit message</label>
      <input id="commitMsg" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã" />
    </div>

    <div style="margin:12px 0;">
      <button id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å data.json</button>
      <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å data.json</button>
      <span class="small">(–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ ‚Äî –∑–∞—Ç–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ)</span>
    </div>

    <div id="status" class="status-box" style="display:none"></div>

    <div id="adminBracket"></div>

    <h3>–õ–æ–≥</h3>
    <pre id="log" class="log"></pre>
  </div>

  <script>
  function toBase64(str){ return btoa(unescape(encodeURIComponent(str))); }
  function fromBase64(b64){ return decodeURIComponent(escape(atob(b64))); }

  const ownerInput = document.getElementById('owner');
  const repoInput = document.getElementById('repo');
  const tokenInput = document.getElementById('token');
  const saveTokenBtn = document.getElementById('saveTokenBtn');
  const loadBtn = document.getElementById('loadBtn');
  const saveBtn = document.getElementById('saveBtn');
  const commitMsgInput = document.getElementById('commitMsg');
  const adminBracket = document.getElementById('adminBracket');
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');

  let fileSha = null;
  let dataset = null;
  const PATH = 'data.json';

  function log(msg){
    const time = new Date().toLocaleTimeString();
    logEl.textContent += `[${time}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function showStatus(text, type='info'){
    statusEl.style.display = 'block';
    statusEl.textContent = text;
    statusEl.className = 'status-box ' + (type==='success'?'success': type==='error'?'error':'loading');
  }

  saveTokenBtn.addEventListener('click', ()=>{
    const token = tokenInput.value.trim();
    if(!token){ showStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error'); return; }
    sessionStorage.setItem('GHTOKEN', token);
    showStatus('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success'); log('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  });

  loadBtn.addEventListener('click', async ()=>{
    const owner = ownerInput.value.trim();
    const repo = repoInput.value.trim();
    const token = sessionStorage.getItem('GHTOKEN');
    if(!owner || !repo){ showStatus('–£–∫–∞–∂–∏—Ç–µ owner –∏ repo', 'error'); return; }
    if(!token){ showStatus('–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error'); return; }

    showStatus('–ó–∞–≥—Ä—É–∂–∞—é data.json...', 'loading');
    try{
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${PATH}`, {
        headers: { Authorization: `token ${token}` }
      });
      if(!res.ok){ const err = await res.json(); throw new Error(err.message || res.status); }
      const j = await res.json();
      fileSha = j.sha;
      dataset = JSON.parse(fromBase64(j.content));
      showStatus('‚úÖ data.json –∑–∞–≥—Ä—É–∂–µ–Ω', 'success'); 
      renderAdmin(dataset.rounds);
    }catch(e){ showStatus('–û—à–∏–±–∫–∞: '+e.message, 'error'); log('–û—à–∏–±–∫–∞: '+e.message); }
  });

  function renderAdmin(rounds){
    adminBracket.innerHTML = '';
    rounds.forEach((round, rIndex) => {
      const block = document.createElement('div');
      block.className = 'round';
      const h = document.createElement('h3'); h.textContent = round.name; block.appendChild(h);

      round.matches.forEach((m, mIndex) => {
        const row = document.createElement('div');
        row.className = 'match';
        row.style.display = 'flex'; row.style.gap='8px'; row.style.alignItems='center';
        row.innerHTML = `
          <input data-r="${rIndex}" data-m="${mIndex}" data-field="teamA" value="${m.teamA}" />
          <input data-r="${rIndex}" data-m="${mIndex}" data-field="scoreA" type="number" value="${m.scoreA}" style="width:80px"/>
          <span style="margin:0 6px">vs</span>
          <input data-r="${rIndex}" data-m="${mIndex}" data-field="teamB" value="${m.teamB}" />
          <input data-r="${rIndex}" data-m="${mIndex}" data-field="scoreB" type="number" value="${m.scoreB}" style="width:80px"/>
        `;
        row.querySelectorAll('input').forEach(inp=>{
          inp.addEventListener('change', ()=>{
            const r = +inp.dataset.r, mm = +inp.dataset.m, field = inp.dataset.field;
            const val = field.includes('score') ? Number(inp.value) : inp.value;
            dataset.rounds[r].matches[mm][field] = val;
          });
        });
        block.appendChild(row);
      });

      adminBracket.appendChild(block);
    });
  }

  saveBtn.addEventListener('click', async ()=>{
    const owner = ownerInput.value.trim();
    const repo = repoInput.value.trim();
    const token = sessionStorage.getItem('GHTOKEN');
    const commitMsg = commitMsgInput.value.trim() || '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ data.json';
    if(!owner||!repo||!token||!dataset) return;

    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${PATH}`;
    const content = toBase64(JSON.stringify(dataset, null, 2));

    showStatus('–û—Ç–ø—Ä–∞–≤–∫–∞...', 'loading');
    try{
      const res = await fetch(url, {
        method:'PUT',
        headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ message: commitMsg, content, sha: fileSha })
      });
      const result = await res.json();
      if(res.ok){ fileSha = result.content.sha; showStatus('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success'); log('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
      else throw new Error(result.message || '–û—à–∏–±–∫–∞');
    }catch(err){ showStatus('–û—à–∏–±–∫–∞: '+err.message, 'error'); log(err.message); }
  });
  </script>
</body>
</html>
